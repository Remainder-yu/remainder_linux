# 虚拟化概述


参考论文：
《基于Xen的安全虚拟化平台及应用研究》

# xen
《采用全虚拟化的多嵌入式操作系统的研究和实现》·
xen 是著名的服务器虚拟化解决方案，近年来它退出了ARM版本，可以应用于嵌入式领域。
Xen是一个Type-1型的，使用微内核架构的Hypervisor，它仅提供对CPU、内存及中断的虚拟化，以及域间通信功能，而将设备虚拟化工作交由特权域完成。

![](vx_images/301353817142274.png =500x)

本文详细分析了xen-ARM的去虚拟化实现细节，着重从CPU虚拟化、内存虚拟化、中断虚拟化、设备虚拟化和时钟虚拟化等方面对Xen虚拟化原理的分析。

## 虚拟化技术概论
VM：vitual machine，使用虚拟化技术实现的虚拟硬件平台通常称为虚拟机。
GuestOS：运行在VM中的操作系统被称为客户操作系统。
Hypervisor：真实的硬件平台和VM则由虚拟机监控器（VMM，Virtual Machine Monitor）控制，简称虚拟机监控器，也称为Hypervisor。

### 虚拟化技术理论
页基地址寄存器：
CPU运行模式：特权指令、敏感指令

如果一个CPU指令集将特权指令和敏感指令明显区分开，那么该指令集支持虚拟化。Hypervisor可以通过对导致陷入的敏感指令进行模拟，避免GUestOS对系统资源配置进行修改，保证Hypervisor对系统资源的绝对控制权。

按照Hypervisor是否直接运行在裸机上的标准，可以将虚拟机分为Type-1和Type-2.不论哪种类型，都必须实现CPU虚拟化、内存虚拟化、中断虚拟化、以及时间虚拟化等功能模块。通常被实现在VMM中。

xen基础结构：

### xen的核心设备驱动核心描述

该小结参考《基于虚拟机监控器Xen的性能评估》：针对该文章时间较早，但是当时研究背景现在确实符合实际情况，所以该文章的角度价值大于当前文章的研究内容，同时该文章的概念性阐述还是较高的价值，可以参考作为基础学习。

在半虚拟化Xen的环境中，DOM0提供物理设备的驱动程序。这就如同一般操作系统对硬件的访问，唯一不同的是它是通过Xen虚拟机监控器来访问。而那些没有访问权限的域，则是将这些驱动程序的半虚拟化挂件作为虚拟设备驱动程序，通过修改DomU的内核，他们可以通过Dom0的物理驱动与每个虚拟驱动实现通信。
Xen虚拟设备使用分立设备驱动结构，它包括两个部分：
* 前端驱动器（frontend driver）：位于DomU中的虚拟驱动器。在DomU看来，前端驱动器提供的是真实设备。因为无权访问真正的硬件，它们只能将I/O请求从自己的内核传输给后端驱动器。
* 后端驱动器（backend driver）：位于Dom0中的物理驱动的接口。后端驱动器负责从前端驱动器接收IO请求，并将他们传输至物理驱动。
这些分立驱动器通过一个域和域之间的事件通道在共享内存中实现通信。前端驱动器和后端驱动器将请求/响应放到共享内存中，并在事件通道上进行数据传输。这种机制保证了对于设备访问的高效性，因为这种机制允许数据成批发送。因此，半虚拟化在某种情况下xen客户机的性能更好，例如，网络性能。

基于半虚拟化的Xen客户机的操作系统必须经过底层代码修改，同时它能取得较之于完全虚拟化的Xen客户机更高的性能。而完全虚拟化的Xen客户机无需内核的修改，但必须付出性能代码。

Xen3支持对称多处理器SMP内核的虚拟机。
在虚拟机监控器Xen中，CPU、内存、IO、中断分别来进行虚拟化。
其中整体架构图2.1,xen基本结构可以参考学习。


## 内存虚拟化

在未虚拟化的环境中，操作系统期待获得连续内存块，而在半虚拟化的Xen客户机中，通过修改内核代码，将实现对于非连续内存的访问，客户机操作系统将单独负责分配管理页表。但是，客户机的写操作将触发中断，其必须通过Xen虚拟机监控器的验证。

## 学习思路
1. 背景及主要概念
2. 项目整体架构
3. xen基本原理：CPU虚拟化、内存管理虚拟化、中断虚拟化、IO虚拟化、时钟虚拟化
4. 对应xen进行相关操作系统原有补充，内存管理、底层寄存器操作、调度算法。
5. xen系统搭建和系统管理：
6. xen性能测试：
7. xen的性能优化：

### 目前主要进行：
1，2，3点，然后系统搭建及系统管理基本操作，
补充设备树如何创建设备节点，实操单板，搭建单板环境，学习物理单板的实际开发，而不是qemu上进行操作。
qemu适合学习内核和OS架构，不适合学习驱动，但是作为未来个人核心能力，必须提高驱动相关知识。

## 参考论文：
《采用全虚拟化的多嵌入式操作系统的研究和实现》

